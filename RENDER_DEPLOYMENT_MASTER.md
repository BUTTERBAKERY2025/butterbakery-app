# دليل نشر تطبيق ButterBakery على منصة Render.com

## مقدمة

هذا الدليل الشامل يوضح خطوات نشر تطبيق ButterBakery على منصة Render.com، مع التركيز على حل المشكلات الشائعة وضمان استمرارية عمل قاعدة البيانات. يتضمن الدليل إرشادات متوافقة مع أحدث إصدارات Node.js.

## محتويات الدليل

1. [نشر التطبيق مع Node.js v22](#نشر-التطبيق-مع-nodejs-v22)
2. [إعداد وربط قاعدة بيانات PostgreSQL](#إعداد-وربط-قاعدة-بيانات-postgresql)
3. [استخدام Render API للنشر التلقائي](#استخدام-render-api-للنشر-التلقائي)
4. [التعامل مع مشكلات الاتصال بقاعدة البيانات](#التعامل-مع-مشكلات-الاتصال-بقاعدة-البيانات)
5. [استمرارية البيانات أثناء التحديثات](#استمرارية-البيانات-أثناء-التحديثات)
6. [الأسئلة الشائعة والاستكشاف وإصلاح الأخطاء](#الأسئلة-الشائعة-والاستكشاف-وإصلاح-الأخطاء)

## نشر التطبيق مع Node.js v22

### المشكلة الشائعة
تستخدم منصة Render.com حاليًا Node.js v22.12.0 بشكل افتراضي، بينما تم تطوير معظم تطبيقات Node.js باستخدام الإصدار v20.x أو أقدم. هذا يؤدي إلى ظهور أخطاء مثل `require is not defined` بسبب اختلاف التعامل مع وحدات ES Modules.

### الحل: استخدام ملف بدء متوافق

1. **تم إنشاء ملف `start-render-node22.js`** متوافق تمامًا مع Node.js v22 ويعمل كنقطة دخول للتطبيق.
2. **استخدام ESM بدلاً من CommonJS** في ملف البدء لضمان التوافق.
3. **التعامل مع المكتبات التي تستخدم CommonJS** من خلال استيراد الحزم باستخدام `import pkg from 'module'`.

### خطوات النشر

استخدم سكريبت `deploy-to-render-node22.sh` لإنشاء مستودع GitHub جديد والنشر من خلال Render.com:

```bash
# التحقق من توفر توكن GitHub
export GITHUB_TOKEN=your_token_here

# تنفيذ سكريبت النشر
bash deploy-to-render-node22.sh
```

للمزيد من التفاصيل، راجع [دليل النشر مع Node.js v22](RENDER_DEPLOYMENT_NODE22.md).

## إعداد وربط قاعدة بيانات PostgreSQL

### إنشاء قاعدة بيانات PostgreSQL على Render.com

1. اذهب إلى [لوحة تحكم Render.com](https://dashboard.render.com/)
2. انقر على "New +" واختر "PostgreSQL"
3. أدخل المعلومات المطلوبة:
   - اسم قاعدة البيانات: `butterbakery-db`
   - خطة الاستخدام: اختر الخطة المناسبة لاحتياجاتك
4. انقر على "Create Database"

### ربط قاعدة البيانات بتطبيق الويب

1. انتقل إلى صفحة قاعدة البيانات التي تم إنشاؤها
2. انسخ "Internal Database URL" من قسم "Connections"
3. انتقل إلى صفحة خدمة الويب، ثم اذهب إلى "Environment"
4. أضف متغير بيئة `DATABASE_URL` بقيمة الرابط الذي نسخته

للمزيد من التفاصيل، راجع [دليل إعداد PostgreSQL](RENDER_POSTGRES_INSTRUCTIONS.md).

## استخدام Render API للنشر التلقائي

يمكنك استخدام Render API لأتمتة عملية النشر والتحكم في الخدمات برمجيًا:

```bash
# تعيين متغيرات البيئة المطلوبة
export RENDER_API_KEY=your_api_key_here
export RENDER_SERVICE_ID=srv-your_service_id

# تشغيل سكريبت النشر التفاعلي
node render-api-deploy.js
```

للمزيد من التفاصيل حول استخدام Render API، راجع [دليل استخدام Render API](RENDER_API_DEPLOYMENT.md).

## التعامل مع مشكلات الاتصال بقاعدة البيانات

### المشكلات الشائعة

1. **خطأ `getaddrinfo ENOTFOUND`**: يحدث عندما يكون رابط قاعدة البيانات غير صحيح أو غير متاح
2. **خطأ `connection refused`**: يحدث عندما تكون قاعدة البيانات في وضع السكون أو غير مستجيبة
3. **خطأ `SSL connection required`**: يجب تعيين خيار `ssl: { rejectUnauthorized: false }` في إعدادات الاتصال

### الحلول

1. **تحقق من صحة رابط الاتصال** في متغيرات البيئة
2. **تنشيط قاعدة البيانات** من لوحة تحكم Render إذا كانت في وضع السكون
3. **استخدام آلية إعادة المحاولة** للاتصال بقاعدة البيانات في بداية تشغيل التطبيق
4. **تضمين معلومات تشخيصية** في صفحة حالة النظام

للمزيد من التفاصيل، راجع نقطة النهاية `/api/db/status` المتاحة في التطبيق.

## استمرارية البيانات أثناء التحديثات

لضمان عدم فقدان البيانات أثناء إعادة تشغيل التطبيق أو تحديثه، تم توفير آليات النسخ الاحتياطي والاستعادة:

```javascript
// النسخ الاحتياطي قبل التحديث
async function backupDatabase() {
  // تنفيذ النسخ الاحتياطي
}

// استعادة البيانات بعد التحديث
async function restoreDatabaseIfEmpty(backupFilePath) {
  // استعادة البيانات إذا كانت الجداول فارغة
}

// العملية الكاملة للحفاظ على البيانات عند التحديث
async function maintainDataPersistence() {
  const backupFile = await backupDatabase();
  // ... التحديث أو إعادة التشغيل ...
  await restoreDatabaseIfEmpty(backupFile);
}
```

للمزيد من التفاصيل، راجع التنفيذ في ملف [database-persistence.js](database-persistence.js).

## الأسئلة الشائعة والاستكشاف وإصلاح الأخطاء

### التطبيق يعمل محليًا ولكن لا يعمل على Render.com

1. **تحقق من إعدادات البيئة**: تأكد من وجود جميع متغيرات البيئة المطلوبة على Render.com
2. **راجع سجلات الخادم**: افحص سجلات Render للعثور على أي أخطاء
3. **افحص إصدار Node.js**: تأكد من استخدام ملف البدء المتوافق مع إصدار Node.js المستخدم

### لماذا تظل قاعدة البيانات تدخل في وضع السكون؟

في الخطة المجانية، تدخل قاعدة بيانات Render.com في وضع السكون بعد فترة من عدم النشاط (عادةً 15 دقيقة). الحلول:

1. **استخدام "health check" منتظم** لإبقاء قاعدة البيانات نشطة
2. **الترقية إلى خطة مدفوعة** للحصول على توافر مستمر

### كيف يمكنني تشغيل سكريبت الهجرة عند كل نشر؟

يمكنك تضمين سكريبت الهجرة في أمر البناء على Render.com:

```
npm install && npm run db:migrate
```

للمزيد من التفاصيل حول استكشاف الأخطاء وإصلاحها، راجع [دليل استكشاف الأخطاء وإصلاحها](TROUBLESHOOTING.md).

---

## المساهمة

نرحب بمساهماتك لتحسين هذا الدليل! يرجى إرسال اقتراحاتك أو تصحيحاتك عبر GitHub.

## الترخيص

جميع الحقوق محفوظة © 2025 ButterBakery OPS