#!/bin/bash

# ุณูุฑูุจุช ูุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู Drizzle ORM
# ูุณุชุฎุฏู ูุฐุง ุงูุณูุฑูุจุช ูุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุนุฏ ุงููุดุฑ ุนูู Render.com

echo "๐๏ธ ุจุฏุก ุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."

# ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑ ุจูุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
if [ -z "$DATABASE_URL" ]; then
    echo "โ ุฎุทุฃ: ูุชุบูุฑ ุงูุจูุฆุฉ DATABASE_URL ุบูุฑ ููุฌูุฏ"
    echo "ูุฑุฌู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ DATABASE_URL ูุจู ุชุดุบูู ูุฐุง ุงูุณูุฑูุจุช"
    exit 1
fi

# ุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู Drizzle
echo "๐ ุชูููุฐ ุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู Drizzle..."
npx drizzle-kit push:pg

# ุฑูุฒ ุงูุฎุฑูุฌ ูู ุงูุฃูุฑ ุงูุณุงุจู
EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo "โ ุชู ุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ"
else
    echo "โ ูุดู ุชุฑุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุฑูุฒ ุงูุฎุทุฃ: $EXIT_CODE"
    exit $EXIT_CODE
fi

echo "๐ ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
node deploy/check_database.js

echo "๐ ุงูุชูู ุชูููุฐ ุณูุฑูุจุช ุงูุชุฑุญูู"
exit 0