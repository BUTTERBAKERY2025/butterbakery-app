# دليل النشر في AWS لتطبيق ButterBakery-OP

## نظرة عامة

هذه الوثيقة توضح خطة النشر والهجرة من بيئة Replit إلى AWS لتطبيق ButterBakery-OP. تهدف هذه الخطة إلى تحقيق:

- استراتيجية نشر بدون توقف (Zero-Downtime Deployment)
- تحسين الأداء والاعتمادية
- قابلية التوسع تلقائيًا حسب الحمل
- مراقبة شاملة للتطبيق
- استراتيجية نسخ احتياطي واستعادة موثوقة

## البنية التحتية المستخدمة

تعتمد البنية التحتية في AWS على المكونات التالية:

1. **Amazon RDS for PostgreSQL**: لقاعدة البيانات مع دعم Multi-AZ للتوفر العالي
2. **AWS Elastic Beanstalk**: لاستضافة التطبيق مع استراتيجية النشر الأزرق/الأخضر (Blue/Green Deployment)
3. **Amazon S3**: لتخزين الحزم والأصول الثابتة
4. **AWS CloudWatch**: لمراقبة الأداء والسجلات
5. **AWS Route 53**: لإدارة نطاق DNS
6. **AWS CloudFront**: لتسريع توصيل المحتوى الثابت

## استراتيجية النشر الأزرق/الأخضر

نستخدم استراتيجية النشر الأزرق/الأخضر لضمان استمرارية الخدمة أثناء النشر:

1. البيئة الزرقاء (Blue): بيئة الإنتاج الحالية
2. البيئة الخضراء (Green): بيئة الإنتاج الجديدة

عند نشر إصدار جديد:
- يتم نشر الإصدار الجديد إلى البيئة غير النشطة
- يتم فحص صحة البيئة الجديدة
- يتم تبديل عناوين URL عند نجاح الفحوصات (مما يعني تحويل حركة المرور إلى الإصدار الجديد)
- البيئة القديمة تظل متاحة للرجوع السريع في حالة اكتشاف مشاكل

## خطوات الهجرة

### 1. إعداد AWS

1. إنشاء حساب AWS وتكوين IAM
2. إنشاء قاعدة بيانات RDS
3. إنشاء تطبيق Elastic Beanstalk
4. إعداد S3 Bucket

### 2. ترحيل البيانات

1. إنشاء نسخة احتياطية من قاعدة البيانات الحالية
2. استيراد البيانات إلى RDS
3. التحقق من اكتمال البيانات ونزاهتها

### 3. نشر التطبيق

1. تكوين CI/CD باستخدام GitHub Actions
2. نشر الإصدار الأولي إلى بيئة الاختبار
3. تخصيص النطاق
4. تبديل حركة المرور

## الملفات المستخدمة في عملية النشر

- `.ebextensions/`: مجلد يحتوي على ملفات تكوين Elastic Beanstalk
  - `nodecommand.config`: تكوين أمر تشغيل Node.js
  - `healthcheckurl.config`: تكوين عنوان URL لفحص صحة التطبيق
  - `cloudwatch.config`: تكوين وكيل CloudWatch لجمع السجلات والمقاييس
  - `cloudwatch-alarms.config`: تكوين تنبيهات CloudWatch المبنية مسبقًا
  - `nodejs-optimizations.config`: تحسينات أداء Node.js وNginx
  - `deployment-strategy.config`: استراتيجية النشر والتوسع التلقائي
  - `email-notifications.config`: إعداد إشعارات البريد الإلكتروني للتنبيهات
- `aws_rds_config.json`: ملف تكوين RDS
- `elasticbeanstalk-config.json`: ملف تكوين Elastic Beanstalk
- `db_migration.sh`: سكريبت ترحيل قاعدة البيانات
- `scripts/`: مجلد السكريبتات المساعدة
  - `auto_backup.sh`: سكريبت النسخ الاحتياطي التلقائي اليومي
  - `restore_backup.sh`: سكريبت استعادة النسخ الاحتياطية
- `.github/workflows/aws-deploy.yml`: ملف تكوين GitHub Actions للـ CI/CD

## متطلبات ما قبل النشر

1. **أسرار AWS**: تأكد من إعداد الأسرار التالية في GitHub:
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`
   - `AWS_REGION`
   - `AWS_S3_BUCKET`

2. **مراجعة الإعدادات**: تأكد من تحديث جميع القيم المشار إليها بـ "REPLACE_WITH_*" في ملفات التكوين.

## خطة الرصد والمراقبة

1. **CloudWatch Alarms**: تم إعداد تنبيهات آلية بواسطة ملف `cloudwatch-alarms.config` لمراقبة الحالات الحرجة:
   - استخدام وحدة المعالجة المركزية > 80% (تنبيه + توسيع تلقائي)
   - استخدام وحدة المعالجة المركزية < 20% (تقليص تلقائي)
   - استخدام الذاكرة > 80% (تنبيه فقط)
   - زمن استجابة API > 2 ثانية (تنبيه فقط)
   - أخطاء HTTP 5xx > 10 طلبات خلال 5 دقائق (تنبيه فقط)

2. **سجلات التطبيق**: تم تكوين CloudWatch Logs تلقائياً بواسطة ملف `cloudwatch.config` لجمع السجلات التالية:
   - سجلات Node.js (/var/log/nodejs/nodejs.log)
   - سجلات محرك EB (/var/log/eb-engine.log)
   - سجلات Nginx للوصول والأخطاء (/var/log/nginx/access.log و /var/log/nginx/error.log)
   
3. **مقاييس التطبيق**: تم إعداد قياسات مخصصة لمراقبة الموارد:
   - استخدام الذاكرة
   - استخدام المبادلة (swap)
   - استخدام القرص

## خطة النسخ الاحتياطي والاستعادة

1. **النسخ الاحتياطي التلقائي**: تم إعداد سكريبت `auto_backup.sh` للنسخ الاحتياطي التلقائي مع الميزات التالية:
   - نسخ احتياطي يومي يحتفظ به لمدة 7 أيام
   - نسخ احتياطي أسبوعي (كل يوم أحد) يحتفظ به لمدة 4 أسابيع
   - نسخ احتياطي شهري (نهاية كل شهر) يحتفظ به لمدة 12 شهرًا
   - نسخ احتياطي سنوي (1 يناير) يحتفظ به بشكل دائم

2. **إدارة النسخ الاحتياطي**: يتم تخزين النسخ الاحتياطية في Amazon S3 مع هيكل مجلدات يعكس استراتيجية الاحتفاظ:
   ```
   s3://bucket-name/db-backups/
   ├── daily/                 # تُحفظ لمدة 7 أيام
   ├── weekly/                # تُحفظ لمدة 4 أسابيع
   │   ├── 1/                 # الاثنين
   │   ├── 2/                 # الثلاثاء
   │   └── ...
   ├── monthly/               # تُحفظ لمدة 12 شهراً
   │   ├── 01/                # يناير
   │   ├── 02/                # فبراير
   │   └── ...
   └── yearly/                # تُحفظ بشكل دائم
       ├── 2025/
       ├── 2026/
       └── ...
   ```

3. **استعادة النسخ الاحتياطي**: تم إعداد سكريبت `restore_backup.sh` للاستعادة السهلة للنسخ الاحتياطية عند الحاجة، مع ميزات:
   - إنشاء نسخة احتياطية أمان قبل الاستعادة
   - إعادة إنشاء قاعدة البيانات بالكامل إذا لزم الأمر
   - تقرير مفصل عن عملية الاستعادة

4. **اختبار الاستعادة**: يجب جدولة اختبار شهري لعملية الاستعادة باستخدام السكريبت المتوفر للتأكد من فعالية خطة النسخ الاحتياطي

## قائمة التحقق قبل الإطلاق

- [ ] إكمال إعداد جميع خدمات AWS
- [ ] تكوين S3 Bucket للنسخ الاحتياطية مع سياسات الوصول المناسبة
- [ ] تحديث القيم الفعلية في ملفات التكوين (استبدال REPLACE_WITH_*)
- [ ] إعداد إشعارات البريد الإلكتروني للتنبيهات وتأكيد استلامها
- [ ] اختبار سكريبت ترحيل البيانات في بيئة اختبار
- [ ] اختبار سكريبت النسخ الاحتياطي ومخطط الاحتفاظ
- [ ] اختبار سكريبت استعادة النسخ الاحتياطية مع تأكيد صحة البيانات
- [ ] اختبار النشر باستخدام CI/CD في بيئة اختبار (استراتيجية الأزرق/الأخضر)
- [ ] التحقق من فحص الصحة ونقاط النهاية API في البيئة الجديدة
- [ ] التحقق من سجلات المراقبة وتنبيهات CloudWatch
- [ ] إجراء اختبار حمل للتأكد من الأداء وقابلية التوسع
- [ ] إجراء تعتيم المثيل (instance termination) لاختبار التعافي التلقائي
- [ ] محاكاة السيناريوهات المختلفة لسجلات الأخطاء واختبار الاستجابة
- [ ] اختبار خطة الرجوع مع تبديل الإصدارات والاستعادة

## مسؤوليات الفريق

- **مسؤول DevOps**: إعداد البنية التحتية، CI/CD، المراقبة
- **مطور قاعدة البيانات**: ترحيل قاعدة البيانات، التحقق من البيانات
- **مطور الواجهة الخلفية**: تكوين التطبيق، نقاط نهاية API
- **مطور الواجهة الأمامية**: التحقق من واجهة المستخدم، تحسين الأداء
- **مدير المشروع**: تنسيق عملية الهجرة، التواصل مع أصحاب المصلحة

## جدول الهجرة

1. **يوم -7**: إعداد البنية التحتية في AWS
2. **يوم -3**: ترحيل البيانات للاختبار
3. **يوم -2**: نشر التطبيق إلى بيئة الاختبار
4. **يوم -1**: الاختبار النهائي والتحقق
5. **يوم 0 (النشر)**:
   - ترحيل البيانات النهائي
   - نشر التطبيق إلى الإنتاج
   - تبديل حركة المرور
   - مراقبة مكثفة (24 ساعة)

## خطة الرجوع

في حالة حدوث مشكلة بعد النشر:

1. **المشكلات الصغيرة**: إصلاح المشكلة ونشر تصحيح
2. **المشكلات الكبيرة**: التبديل فورًا إلى البيئة السابقة (البيئة الأخرى في استراتيجية الأزرق/الأخضر)
3. **مشكلات قاعدة البيانات**: استعادة آخر نسخة احتياطية

## التوثيق الإضافي

- [وثائق AWS Elastic Beanstalk](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html)
- [وثائق AWS RDS للـ PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html)
- [النشر الأزرق/الأخضر مع Elastic Beanstalk](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.CNAMESwap.html)